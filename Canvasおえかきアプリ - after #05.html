<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Canvasおえかき</title>
    <style>
        #mycanvas {
            border: 10px solid #999;
        }
        .thumbnail {
            border: 2px solid #999;
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <p>
        <select id="penColor">
            <option value="black">Black</option>
            <option value="red">Red</option>
            <option value="blue">Blue</option>
            <option value="white">White</option>
        </select>
        <select id="penWidth">
                <option value="1">Thin</option>
                <option value="3">Normal</option>
                <option value="5">Thick</option>
        </select>
        <input type="button" id="erase" value="Clear">
        <input type="button" id="save" value="Add to Gallery">
    </p>
    <canvas width="400" height="200" id="mycanvas">
            Your browser does not support Canvas
    </canvas>
    <div id="gallery"></div>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>
        $(function(){
            var canvas = document.getElementById('mycanvas');
            // to check whether canvas is working with JS
            if (!canvas || !canvas.getContext) return false;

            var ctx = canvas.getContext('2d');

            // to capture mouse movement e = mouse coordinate

            var startX, // mousedown coordinate (where mouse was clicked)
                startY,
                x, // coordinate after movement
                y,
                borderWidth = 10, 
                isDrawing = false; // false and not draw if not mousedown(not clicked)

            $('#mycanvas').mousedown(function(e){
                // to work out how far #mycanvas is from browser border (minus borderWidth)
                isDrawing = true; // becomes true if mousedown(clicked)
                startX = e.pageX - $(this).offset().left - borderWidth;
                startY = e.pageY - $(this).offset().top - borderWidth;
            })
            .mousemove(function(e){
                if (!isDrawing) return; // only draw if mousemove as well as mousedown
                x = e.pageX - $(this).offset().left - borderWidth;
                y = e.pageY - $(this).offset().top - borderWidth;
                // draw a line from mousedown(StartX StartY) to mouseoff x y
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(x, y);
                ctx.stroke();
                startX = x;
                startY = y;
            })
            .mouseup(function(){
                isDrawing = false;
            })
            // stops drawing when mouse leaves out of canvas border
            .mouseleave(function(){
                // isDrawing = false;
            });

            // for penColor option menu
            $('#penColor').change(function(){
                ctx.strokeStyle = $(this).val();
            });
            // for penWidth option menu
            $('#penWidth').change(function(){
                ctx.lineWidth = $(this).val();
            });
            // for Clear button
            $('#erase').click(function(){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            // for saving the work and showing on gallery space
            $('#save').click(function(){
                var img = $('<img>').attr({
                    width: 100,
                    height: 50,
                    src: canvas.toDataURL()
                });
               
                // make thumbnail in gallery into links
                var link = $('<a>').attr({
                    href: canvas.toDataURL().replace('image/png',
                    'application/octet-stream'),
                    download: new Date().getTime() + '.png'
                });
                $('#gallery').append(link.append(img.addClass('thumbnail')));
                // clear canvas once img is saved
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
        });  
    </script>
        
  </body>
</html>